## 浏览器大战

首先来一张浏览器战争图。1994年网景发布其第一款浏览器，微软认识到浏览器是互联网主要入口，于1995年发布第一版IE，然后与Win 95绑定销售。至1997年，网景浏览器市场为72%，IE为18%。由于微软在桌面操作系统的垄断性地位，网景节节败退。不得已于2003年将浏览器代码，部分开发人员成立Mozilla组织，并于2004年11月发布第一款火弧浏览器。2008年12月，谷歌加入浏览器战场。从此，IE在火弧、谷歌、Opera、Safari等现代浏览器围攻下，力不从心，使得诸多前端开发者心感安慰。如下是详图：

![浏览器战争图](http://monetate.com/wp-content/uploads/2012/05/monetate_browser_wars_infographic.png)

[其它浏览器份额来源](https://en.wikipedia.org/wiki/Usage_share_of_web_browsers)

[五大主流浏览器对CSS3属性的支持状况](http://fmbip.com/litmus)

## 浏览器概念

[浏览器的组件](http://jbcdn2.b0.upaiyun.com/2012/02/How-browsers-work1.png)
- 用户界面
- 浏览器引擎
 + 渲染引擎 - 显示请求的内容
 + 解释引擎 - 查询和操作渲染引擎的接口
- 网络 - 用于网络请求，如 HTTP 请求
- UI后端 - 绘制基础元件，如组合框和窗口
- 数据存储

![](http://taligarsiel.com/Projects/layers.png)

PS：Chrome的每个Tab页面都使用一个渲染引擎实例，占用一个进程。

### 浏览器的用户接口

- 用于输入URL的地址栏、状态栏等
- 工具栏里的前进后退、刷新停止按钮、插件图标等
- 书签

### 渲染引擎

- Chrome/Opera: Blink(2013年从WebKit的Webcore分支而来)
- Firefox: Gecko
- Safari: WebKit的WebCore
- IE: Trident

默认情况下可以显示HTML、XML等文档，通过插件（扩展）可以显示其它类型的文档，如PDF。

#### 渲染流程

![](http://taligarsiel.com/Projects/flow.png)

首先将HTML文档中的元素解析成DOM树，并且解析文档中包含的样式，然后创建（渲染引擎，有JS则调用JS引擎）一棵渲染树，之后进行布局并绘制（UI后端）出来。渲染树在创建过程中，浏览器便会进行绘制。

### 网络

HTTP或者HTTPS协议都依赖于传输层协议TCP的，而TCP协议依赖于网络层的IP协议。所以要在服务器和客户端之间传输文件，必须首先知道服务器的IP。在地址栏键入URL后，若浏览器缓存里没有对应映射，则会进行DNS查询，进行IP解析。获取主机IP后，进行TCP三次握手，建立连接，开始发送HTTP请求。请求包括请求行、请求头、请求主体（POST方式）。服务器收到请求后，执行响应程序，返回HTTP文档。

![](http://yp.oss.org.cn/images/resource_images/20110727-102123//1311733283.jpg)

### JS解析引擎

- IE & EDGE: Chakra
- Chrome & NodeJS: V8
- Safari & PhantomJS: Nitro
- Firefox: SpiderMonkey -> TraceMonkey
- HTMLUnit: Rhino

#### V8：

- basecompiler：生成机器码
- 通过objectmodel来表达对象。
- runtimeprofiler：标识出“热点函数”
- optimizingcompiler：重新编译并优化“热点函数”。如把代码进行内联化-即在函数被调用的地方用函数主体取代。

垃圾回收是一种内存管理机制。

### 浏览器显示网页流程

![Webkit](http://taligarsiel.com/Projects/webkitflow.png)

上图为Webkit系渲染流程

![Gecko](http://taligarsiel.com/Projects/image008.jpg)

上图为火弧渲染流程

因为JS的单线程，在生成渲染树的时候，若遇到JS，则会停步渲染而执行JS代码，更改渲染树，这称为重排（Layout / Reflow），代价大；而若只是背景颜色、字体颜色等不更改文档流的操作，只会进行重绘，代价小。

### 兼容性问题

- png24的图片在IE6上需要转换成png8
- 浏览器默认的margin/padding不同，需要使用* { margin: 0; padding: 0; }